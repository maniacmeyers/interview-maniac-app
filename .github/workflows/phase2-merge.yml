name: Phase 2 Merge Automation
on:
  workflow_dispatch:
jobs:
  phase2-merge:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout main branch
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
    
    - name: Configure git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
    
    - name: Pull ABT/practice features from feat/restore-advanced-features-aug22
      run: |
        # Create temporary directory to handle selective file merging
        git checkout feat/restore-advanced-features-aug22
        mkdir -p temp-abt
        cp src/app/practice/page.tsx temp-abt/ 2>/dev/null || echo "practice/page.tsx not found"
        cp src/components/StoryCreator.tsx temp-abt/ 2>/dev/null || echo "StoryCreator.tsx not found"
        cp src/components/ScoringPanel.tsx temp-abt/ 2>/dev/null || echo "ScoringPanel.tsx not found"
        cp src/components/VoiceRecorder.tsx temp-abt/ 2>/dev/null || echo "VoiceRecorder.tsx not found"
        cp src/components/Gamification.tsx temp-abt/ 2>/dev/null || echo "Gamification.tsx not found"
        cp src/lib/prompts/abt.ts temp-abt/ 2>/dev/null || echo "abt.ts not found"
        cp src/lib/api.ts temp-abt/ 2>/dev/null || echo "api.ts not found"
        
        # Go back to main and apply changes
        git checkout main
        mkdir -p src/app/practice src/components src/lib/prompts
        mv temp-abt/page.tsx src/app/practice/ 2>/dev/null || echo "No practice page to move"
        mv temp-abt/StoryCreator.tsx src/components/ 2>/dev/null || echo "No StoryCreator to move"
        mv temp-abt/ScoringPanel.tsx src/components/ 2>/dev/null || echo "No ScoringPanel to move"
        mv temp-abt/VoiceRecorder.tsx src/components/ 2>/dev/null || echo "No VoiceRecorder to move"
        mv temp-abt/Gamification.tsx src/components/ 2>/dev/null || echo "No Gamification to move"
        mv temp-abt/abt.ts src/lib/prompts/ 2>/dev/null || echo "No abt.ts to move"
        mv temp-abt/api.ts src/lib/ 2>/dev/null || echo "No api.ts to move"
        rm -rf temp-abt
    
    - name: Pull Gemini API route from feat/gemini-iterate-and-firebase-gamification
      run: |
        git checkout feat/gemini-iterate-and-firebase-gamification
        mkdir -p temp-gemini
        cp -r src/app/api/gemini/improve temp-gemini/ 2>/dev/null || echo "gemini/improve route not found"
        
        # Go back to main and apply changes
        git checkout main
        mkdir -p src/app/api/gemini
        mv temp-gemini/improve src/app/api/gemini/ 2>/dev/null || echo "No gemini improve route to move"
        rm -rf temp-gemini
    
    - name: Create wizard page scaffold
      run: |
        mkdir -p src/app/wizard
        # Create wizard page using base64 to avoid YAML parsing issues
        echo "aW1wb3J0IHsgTWV0YWRhdGEgfSBmcm9tICduZXh0JwpleHBvcnQgY29uc3QgbWV0YWRhdGE6IE1ldGFkYXRhID0gewogIHRpdGxlOiAnSW50ZXJ2aWV3IFdpemFyZCAtIEludGVydmlldyBNYW5pYWMnLAogIGRlc2NyaXB0aW9uOiAnU3RlcC1ieS1zdGVwIGludGVydmlldyBwcmVwYXJhdGlvbiB3aXphcmQnCn0KZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gV2l6YXJkUGFnZSgpIHsKICByZXR1cm4gKAogICAgPGRpdiBjbGFzc05hbWU9ImNvbnRhaW5lciBteC1hdXRvIHB4LTQgcHktOCI+CiAgICAgIDxoMSBjbGFzc05hbWU9InRleHQtM3hsIGZvbnQtYm9sZCBtYi02Ij5JbnRlcnZpZXcgUHJlcGFyYXRpb24gV2l6YXJkPC9oMT4KICAgICAgPGRpdiBjbGFzc05hbWU9ImJnLXdoaXRlIHJvdW5kZWQtbGcgc2hhZG93LWxnIHA2Ij4KICAgICAgICA8cCBjbGFzc05hbWU9InRleHQtZ3JheS02MDAgbWItNCI+CiAgICAgICAgICBXZWxjb21lIHRvIHRoZSBJbnRlcnZpZXcgUHJlcGFyYXRpb24gV2l6YXJkISBUaGlzIGd1aWRlZCBleHBlcmllbmNlIHdpbGwgaGVscCB5b3U6CiAgICAgICAgPC9wPgogICAgICAgIDx1bCBjbGFzc05hbWU9Imxpc3QtZGlzYyBwbC02IHNwYWNlLXktMiB0ZXh0LWdyYXktNzAwIj4KICAgICAgICAgIDxsaT5TdHJ1Y3R1cmUgeW91ciBhY2NvbXBsaXNobWVudCBzdG9yaWVzIHVzaW5nIHRoZSBBQlQgZnJhbWV3b3JrPC9saT4KICAgICAgICAgIDxsaT5QcmFjdGljZSB3aXRoIEFJLXBvd2VyZWQgZmVlZGJhY2s8L2xpPgogICAgICAgICAgPGxpPlRyYWNrIHlvdXIgcHJvZ3Jlc3MgYW5kIGltcHJvdmVtZW50czwvbGk+CiAgICAgICAgPC91bD4KICAgICAgICA8ZGl2IGNsYXNzTmFtZT0ibXQtOCI+CiAgICAgICAgICA8cCBjbGFzc05hbWU9InRleHQtc20gdGV4dC1ncmF5LTUwMCI+CiAgICAgICAgICAgIFNjYWZmb2xkIGNyZWF0ZWQgLSByZWFkeSBmb3IgaW1wbGVtZW50YXRpb24KICAgICAgICAgIDwvcD4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICA.pCn0K" | base64 -d > src/app/wizard/page.tsx
    
    - name: Update dashboard links in page.tsx
      run: |
        # Check if src/app/page.tsx exists and update it
        if [ -f "src/app/page.tsx" ]; then
          # Create a backup
          cp src/app/page.tsx src/app/page.tsx.bak
          
          # Add navigation links using base64 to avoid YAML parsing issues
          echo "Ly8gVXBkYXRlZCBkYXNoYm9hcmQgd2l0aCB3aXphcmQgYW5kIHByYWN0aWNlIGxpbmtzCmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIEhvbWVQYWdlKCkgewogIHJldHVybiAoCiAgICA8bWFpbiBjbGFzc05hbWU9ImNvbnRhaW5lciBteC1hdXRvIHB4LTQgcHktOCI+CiAgICAgIDxoMSBjbGFzc05hbWU9InRleHQtNHhsIGZvbnQtYm9sZCB0ZXh0LWNlbnRlciBtYi04Ij4KICAgICAgICBJbnRlcnZpZXcgTWFuaWFjCiAgICAgIDwvaDE+CiAgICAgIAogICAgICA8ZGl2IGNsYXNzTmFtZT0iZ3JpZCBncmlkLWNvbHMtMSBtZDpncmlkLWNvbHMtMiBnYXAtNiBtYXgtdy00eGwgbXgtYXV0byI+CiAgICAgICAgPGRpdiBjbGFzc05hbWU9ImJnLXdoaXRlIHJvdW5kZWQtbGcgc2hhZG93LWxnIHAtNiBob3ZlcjpzaGFkb3cteGwgdHJhbnNpdGlvbi1zaGFkb3ciPgogICAgICAgICAgPGgyIGNsYXNzTmFtZT0idGV4dC0yeGwgZm9udC1zZW1pYm9sZCBtYi00Ij7wn46vIEludGVydmlldyBXaXphcmQ8L2gyPgogICAgICAgICAgPHAgY2xhc3NOYW1lPSJ0ZXh0LWdyYXktNjAwIG1iLTQiPgogICAgICAgICAgICBTdGVwLWJ5LXN0ZXAgZ3VpZGVkIHByZXBhcmF0aW9uIGZvciB5b3VyIGludGVydmlld3MKICAgICAgICAgIDwvcD4KICAgICAgICAgIDxhCiAgICAgICAgICAgIGhyZWY9Ii93aXphcmQiIAogICAgICAgICAgICBjbGFzc05hbWU9ImlubGluZS1ibG9jayBiZy1ibHVlLTYwMCB0ZXh0LXdoaXRlIHB4LTYgcHktMiByb3VuZGVkLWxnIGhvdmVyOmJnLWJsdWUtNzAwIHRyYW5zaXRpb24tY29sb3JzIgogICAgICAgICAgPgogICAgICAgICAgICBTdGFydCBXaXphcmQKICAgICAgICAgIDwvYT4KICAgICAgICA8L2Rpdj4KICAgICAgICAKICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iYmctd2hpdGUgcm91bmRlZC1sZyBzaGFkb3ctbGcgcC02IGhvdmVyOnNoYWRvdy14bCB0cmFuc2l0aW9uLXNoYWRvdyI+CiAgICAgICAgICA8aDIgY2xhc3NOYW1lPSJ0ZXh0LTJ4bCBmb250LXNlbWlib2xkIG1iLTQiPvCfkqogUHJhY3RpY2UgTW9kZTwvaDI+CiAgICAgICAgICA8cCBjbGFzc05hbWU9InRleHQtZ3JheS02MDAgbWItNCI+CiAgICAgICAgICAgIFByYWN0aWNlIHlvdXIgQUJUIHN0b3JpZXMgd2l0aCBBSS1wb3dlcmVkIGZlZWRiYWNrCiAgICAgICAgICA8L3A+CiAgICAgICAgICA8YQogICAgICAgICAgICBocmVmPSIvcHJhY3RpY2UiIAogICAgICAgICAgICBjbGFzc05hbWU9ImlubGluZS1ibG9jayBiZy1ncmVlbi02MDAgdGV4dC13aGl0ZSBweC02IHB5LTIgcm91bmRlZC1sZyBob3ZlcjpiZy1ncmVlbi03MDAgdHJhbnNpdGlvbi1jb2xvcnMiCiAgICAgICAgICA+CiAgICAgICAgICAgIFN0YXJ0IFByYWN0aWNlCiAgICAgICAgICA8L2E+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9tYWluPgogICkKfQo=" | base64 -d > temp-page-update.tsx
          
          # Only replace if the file doesn't already have navigation
          if ! grep -q "/wizard" src/app/page.tsx && ! grep -q "/practice" src/app/page.tsx; then
            mv temp-page-update.tsx src/app/page.tsx
          else
            echo "Dashboard already has navigation links"
            rm temp-page-update.tsx
          fi
        else
          echo "src/app/page.tsx not found - will need manual creation"
        fi
    
    - name: Commit and push changes
      run: |
        git add -A
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "feat: Phase 2 merge - Add ABT practice features, Gemini API, wizard scaffold, and dashboard navigation
          
          - Pull ABT/practice components from feat/restore-advanced-features-aug22
          - Pull Gemini improve API route from feat/gemini-iterate-and-firebase-gamification  
          - Create wizard page scaffold at src/app/wizard/page.tsx
          - Update dashboard with navigation links to /wizard and /practice
          - Automated merge via GitHub Actions workflow"
          git push origin automation/phase2-merge
        fi
    
    - name: Create Pull Request
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pr } = await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'Phase 2 Merge: ABT Practice + Gemini API + Wizard Scaffold',
            head: 'automation/phase2-merge',
            base: 'main',
            body: `# Phase 2 Feature Integration
            
            This PR integrates key features for Phase 2 of the Interview Maniac app:
            
            ## ðŸš€ Features Added
            
            ### ABT Practice Features (from feat/restore-advanced-features-aug22)
            - \`src/app/practice/page.tsx\` - Practice mode interface
            - \`src/components/StoryCreator.tsx\` - Story creation component  
            - \`src/components/ScoringPanel.tsx\` - AI scoring interface
            - \`src/components/VoiceRecorder.tsx\` - Voice recording functionality
            - \`src/components/Gamification.tsx\` - Gamification elements
            - \`src/lib/prompts/abt.ts\` - ABT framework prompts
            - \`src/lib/api.ts\` - API utilities
            
            ### Gemini API Integration (from feat/gemini-iterate-and-firebase-gamification)
            - \`src/app/api/gemini/improve\` - Gemini improvement API route
            
            ### New Features
            - \`src/app/wizard/page.tsx\` - Interview preparation wizard scaffold
            - Updated \`src/app/page.tsx\` with navigation to /wizard and /practice
            
            ## ðŸ“‹ Next Steps for Review
            
            1. **Code Review**: Review merged components for conflicts and compatibility
            2. **Testing**: Test ABT practice flow and Gemini API integration
            3. **UI/UX**: Verify dashboard navigation and wizard scaffold
            4. **Dependencies**: Ensure all required packages are installed
            5. **Environment**: Verify Gemini API keys and Firebase config
            
            ## ðŸš€ Deployment Checklist
            
            - [ ] Review and merge this PR
            - [ ] Test in staging environment
            - [ ] Verify environment variables are set
            - [ ] Deploy to production
            - [ ] Monitor for any issues
            
            ---
            
            *This PR was created automatically via GitHub Actions workflow*`
          });
          
          console.log(`
